trigger:
- main

variables:
  azureSubscription: 'Azure-Sensipro-Prod'
  dockerRegistry: 'sensiproc.azurecr.io'
  imageName: 'auth-service'
  k8sNamespace: 'sensipro-prod'
  tag: '$(Build.BuildId)'

stages:
- stage: Build
  jobs:
  - job: BuildAndTest
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
    
    # Naviguez vers le bon r√©pertoire
    - script: |
        cd Server/src/auth-service
        npm install
        # Supprimez npm run build et npm test si ces scripts n'existent pas
        echo "Build completed successfully"
      displayName: 'Install Dependencies'
    
    - task: Docker@2
      inputs:
        containerRegistry: '$(azureSubscription)'  # Utilisez la service connection
        repository: '$(imageName)'
        command: 'buildAndPush'
        Dockerfile: 'Server/src/auth-service/Dockerfile'  # Chemin correct
        buildContext: 'Server/src/auth-service'  # Contexte de build
        tags: |
          $(tag)
          latest
      displayName: 'Build and Push Docker Image'

- stage: Deploy
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployToAKS
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: KubernetesManifest@0
      inputs:
        action: 'deploy'
        kubernetesServiceConnection: 'aks-sensipro-connection'
        namespace: '$(k8sNamespace)'
        manifests: |
          k8s/auth-service-deployment.yaml
          k8s/auth-service-service.yaml
        containers: '$(dockerRegistry)/$(imageName):$(tag)'
      displayName: 'Deploy to AKS'